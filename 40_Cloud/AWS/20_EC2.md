# EC2

- Elastic Compute Cloud
  - ハードウェア構成や OS を自由に選択できるアンマネージドの仮想マシン
  - インスタンスと呼ばれる単位で提供される
  - 料金:
    - インスタンス使用量
    - EBS 使用量(停止中も課金される)
    - 通信料(アウトバウンドのみ)
    - オプション(Elastic IP、ロードバランサーなど)
  - メリット:
    - CPU、メモリ、ストレージなどのスペックを自由に選べる
    - スケールアップ、スケールダウンが容易
    - SSH や RDP でリモート接続できる
    - Apache 等をインストールすることで Web サーバにできる
  - デメリット:
    - セキュリティ設定や OS のアップデートなどの管理が必要
    - 運用コストがかかるため小規模なアプリケーションには向かない

## AMI: Amazon Machine Image

- インスタンス作成時に選べる OS やソフトウェアの仮想イメージ
  - AWS 提供の無料 AMI やマーケットプレイスの有料 AMI、無料のカスタム AMI などがある
  - 例: Amazon Linux 2、Ubuntu、Red Hat など

## インスタンスタイプ

- インスタンス作成時に選べるハードウェア構成のテンプレート
  - CPU、メモリ、ストレージ、ネットワーク帯域が異なる
  - 例: t2.micro、m5.large、c5.xlarge など
    - t2: バースト可能な汎用インスタンスタイプ
    - m5: 汎用インスタンスタイプ
    - c5: コンピューティング最適化インスタンスタイプ
    - nano 〜 4xlarge: インスタンスサイズ

## キーペア

- SSH 接続するために必要な認証情報
  - 秘密鍵(.pem ファイル) と公開鍵のペアで構成される
  - インスタンス作成時にキーペアを指定し、秘密鍵をダウンロードして保存する
  - インスタンスに接続する際に秘密鍵を使用して認証を行う

## ネットワーク設定

### VPC: 仮想ネットワーク

- EC2のプライベートIPはNATによりグローバルIPに変換される
- デフォルトVPCではNATが設定されているため自動でインターネットに接続できる

### サブネット

- VPC 内の プライベート IP アドレス範囲 + AZ(データセンター群)

### セキュリティグループ: 仮想ファイアウォール, インバウンドとアウトバウンドのルールを設定可

- インバウンド:
  - 0.0.0.0/0 で任意のIPから接続可(デフォルト)
    - SSH ポート 22
    - HTTP ポート 80
    - HTTPS ポート 443
  - RDS に接続する場合は以下のセキュリティグループも別で作成する
    - MYSQL/Aurora TCP 3306 {Web サーバ で作ったセキュリティグループ名}
      - サーバからのみ RDS へ接続できるようにする
- ルートテーブル: サブネット内のインスタンスが外部と通信するための経路を定義
- パブリック IP アドレス: インターネットから接続するために必要
- IAM ロール: インスタンスに AWS のリソースへのアクセス権限を付与する

## ストレージ

- EBS とインスタンスストアがある
  - EBS(EC2 Block Storage Volume): 可用性が高く永久保存できる
  - インスタンスストア: 一時的なストア
  - スナップショットをS3に保存したり、AMIを作成したりできる

## Elastic IP

- 固定のグローバル IP アドレス
  - インスタンスを停止・再起動しても変わらない
  - 無料枠では 1 個まで無料
  - 使用していない Elastic IP は課金される

## ELB: Elastic Load Balancing

- 複数の EC2 インスタンスにトラフィックを分散するサービス
  - 可用性とスケーラビリティを向上させる
  - 種類:
    - ALB(Application Load Balancer): HTTP/HTTPS トラフィック向け
    - NLB(Network Load Balancer): TCP/UDP トラフィック向け
    - CLB(Classic Load Balancer): レガシーアプリケーション向け, 現在は非推奨

## Auto Scaling

- トラフィックの増減に応じて EC2 インスタンスの数を自動的に調整するサービス
  - スケーリングポリシーを設定して、負荷に応じたスケーリングが可能
  - コスト効率と可用性を向上させる

## 接続方法

- Windows の場合
  - RLogin で操作
    - ホスト名: EC2 の IPv4 パブリック IP(再起動すると変わる)
    - ログインユーザー名: ec2-user
    - SSH 認証鍵: EC2 作成時に保存した.pem ファイルを選択
    - プロトコル > KeepAlive パケットの送信間隔: チェックすると通信が切れなくなる
    - フォント > UTF-8
- Mac の場合
  - `chmod 600 awd-key-pair.pem`
    - 作成したキーペアの権限を厳しくしないと AWS に弾かれる -
  - `ssh -i aws-key-pair.pem ec2-user@{IPアドレス}`
    - キーペアを指定して ssh 接続する

## Web サーバをいれる場合

- Apache インストール
  - `sudo yum update -y`
    - パッケージ管理ツール yum のアップデート
  - `sudo yum -y install httpd`
    - Apache を構成する実行ファイルをインストール
  - `sudo systemctl start httpd.service`
    - Apache を起動する
  - `sudo systemctl status httpd.service`
    - Apache が起動しているか確認する, Active なら OK
  - `sudo systemctl enable httpd.service`
    - サーバ起動したら Apache が自動起動するようにする
